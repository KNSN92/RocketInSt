generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                        String               @id @default(cuid())
  name                      String?
  email                     String               @unique
  emailVerified             DateTime?
  image                     String?
  createdAt                 DateTime             @default(now())
  updatedAt                 DateTime             @updatedAt
  campusId                  String?
  role                      Role                 @default(User)
  nickname                  String?
  course                    Course?
  lessonsRegisteredDate     DateTime?
  moderatorOrMentorCampusId String?
  accounts                  Account[]
  Authenticator             Authenticator[]
  sessions                  Session[]
  timeTableFixReports       TimeTableFixReport[] @relation("byUser")
  campus                    Campus?              @relation(fields: [campusId], references: [id])
  moderatorOrMentorCampus   Campus?              @relation("moderatorOrMentorCampus", fields: [moderatorOrMentorCampusId], references: [id])
  lessons                   Lesson[]             @relation("LessonToUser")
  followers                 User[]               @relation("UserFollowRelation")
  following                 User[]               @relation("UserFollowRelation")
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model Authenticator {
  credentialID         String  @unique
  userId               String
  providerAccountId    String
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?
  user                 User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, credentialID])
}

model Campus {
  id                     String      @id @default(uuid())
  name                   String
  mainRoomId             String?     @unique
  memberCount            Int
  mainRoom               Room?       @relation("mainRoom", fields: [mainRoomId], references: [id])
  rooms                  Room[]      @relation("rooms")
  timeTables             TimeTable[]
  members                User[]
  moderatorOrMentorUsers User[]      @relation("moderatorOrMentorCampus")
}

model Room {
  id          String   @id @default(uuid())
  name        String
  campusId    String
  capacity    Int
  roomPlan    Json?
  accentColor String?
  mustShow    Boolean  @default(false)
  order       Int?
  mainFor     Campus?  @relation("mainRoom")
  campus      Campus   @relation("rooms", fields: [campusId], references: [id], onDelete: Cascade)
  lessons     Lesson[] @relation("LessonToRoom")

  @@unique([name, campusId])
  @@unique([order, campusId])
}

model Lesson {
  id        String   @id @default(uuid())
  title     String
  createdAt DateTime @default(now())
  period    Period[] @relation("LessonToPeriod")
  rooms     Room[]   @relation("LessonToRoom")
  students  User[]   @relation("LessonToUser")
}

model Period {
  id        String    @id @default(uuid())
  weekday   WeekDay
  beginTime Int
  endTime   Int
  tag       PeriodTag
  innername String
  name      String
  lessons   Lesson[] @relation("LessonToPeriod")

  @@unique([innername, weekday])
}

model TimeTable {
  id       String               @id @default(uuid())
  date     DateTime
  rawTable Json
  campusId String
  campus   Campus               @relation(fields: [campusId], references: [id])
  reports  TimeTableFixReport[] @relation("TimeTable")
}

model TimeTableFixReport {
  id         String    @id @default(uuid())
  createdAt  DateTime  @default(now())
  byId       String
  reason     String?
  tableId    String
  fixedTable Json
  by         User      @relation("byUser", fields: [byId], references: [id])
  table      TimeTable @relation("TimeTable", fields: [tableId], references: [id])
}

enum Role {
  User
  Admin
  Moderator
  Mentor
}

enum PeriodTag {
  Lesson
  Meeting
  Event
  Other
  Recess
}

enum WeekDay {
  Sunday
  Monday
  Tuesday
  Wednesday
  Thursday
  Friday
  Saturday
}

enum Course {
  OncePerWeek
  ThricePerWeek
  FiveTimesPerWeek
}
